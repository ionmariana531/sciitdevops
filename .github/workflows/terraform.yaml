name: "Terraform CI/CD"

on:
  push:
    branches:
      - add-terraform-github-actions-Mariana-fe

jobs:
  provision-ec2:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - uses: actions/checkout@v3

      # Configurează AWS credentials
      - uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          aws-secret-access-key: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          aws-region: 'eu-west-1'

      # Pasul 3: Obține IP-ul public al GitHub Actions folosind pluginul haythem/public-ip
      - name: Get GitHub Actions Runner IP
        id: ip
        uses: haythem/public-ip@v1.2

      # Pasul 4: Adaugă IP-ul GitHub Actions în Security Group pentru acces SSH
      - name: Add GitHub Actions IP to Security Group for SSH Access
        run: |
          SG_ID="sg-008e2201608e83f75"  # ID-ul Security Group-ului meu
          IP_ADDRESS="${{ steps.ip.outputs.ipv4 }}"  # Folosim ip-ul obținut din pluginul public-ip
          aws ec2 authorize-security-group-ingress --region eu-west-1 --group-id $SG_ID --protocol tcp --port 22 --cidr $IP_ADDRESS/32
          echo "✅ Added GitHub Actions IP ($IP_ADDRESS) to Security Group $SG_ID for SSH access."

      # Pașii de Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform Init
        run: |
          terraform init

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve

      # Salvează IP-urile instanțelor și creează fișierul de inventory pentru Ansible
      - name: Save instance IPs and create inventory
        run: |
          INSTANCE_IPS=$(terraform output -json instance_ips)
          echo "DEBUG: $INSTANCE_IPS"
          echo "$INSTANCE_IPS" | jq -r '.[]' > ansible/instance-ips.txt
          echo "[servers]" > ansible/inventory.ini
          while IFS= read -r ip; do
            echo "$ip ansible_user=ubuntu ansible_ssh_private_key_file=./app-ssh-key.pem" >> ansible/inventory.ini
          done < ansible/instance-ips.txt

      # Verifică conexiunea SSH folosind IP-ul din Terraform
      - name: Test SSH connection
        run: |
          INSTANCE_IP=$(terraform output -json instance_ips | jq -r '.[0]')  # Obține primul IP din lista de IP-uri
          echo "Trying to SSH into $INSTANCE_IP"
          ssh -v -i app-ssh-key.pem ubuntu@$INSTANCE_IP

      # Set Permissions for SSH Key
      - name: Set Permissions for SSH Key
        run: echo "${{ secrets.SSH_PRIVATE_KEY }}" > app-ssh-key.pem && chmod 600 app-ssh-key.pem

      # Install Ansible
      - name: Install Ansible
        run: sudo apt update && sudo apt install -y ansible

      # Run Ansible Playbook
      - name: Run Ansible Playbook
        run: ansible-playbook -i ansible/inventory.ini ansible/playbook.yaml -vvv

      # Pasul 5: Revocă IP-ul GitHub Actions din Security Group
      - name: Revoke GitHub Actions IP from Security Group
        run: |
          SG_ID="sg-008e2201608e83f75"  # ID-ul Security Group-ului meu
          IP_ADDRESS="${{ steps.ip.outputs.ipv4 }}"  # Folosim același IP care a fost adăugat anterior
          aws ec2 revoke-security-group-ingress --region eu-west-1 --group-id $SG_ID --protocol tcp --port 22 --cidr $IP_ADDRESS/32
          echo "❌ Revoked GitHub Actions IP ($IP_ADDRESS) from Security Group $SG_ID."

